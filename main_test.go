package main

import (
	"bytes"
	"io"
	"net/http"
	"net/http/httptest"
	"os"
	"testing"
	"time"

	"github.com/prometheus/client_golang/prometheus"
)

func TestParse(t *testing.T) {

	zs, err := Parse(bytes.NewBufferString(testData))
	if err != nil {
		t.Fatal(err)
	}

	err = RecalcMetrics(zs, time.Now(), time.Now())
	if err != nil {
		t.Fatal(err)
	}

	req, err := http.NewRequest("GET", "/metrics", nil)
	if err != nil {
		t.Fatal(err)
	}

	rr := httptest.NewRecorder()
	prometheus.Handler().ServeHTTP(rr, req)
	if err != nil {
		t.Fatal(err)
	}

	io.Copy(os.Stdout, rr.Body)

	err = RecalcMetrics(zs, time.Now(), time.Now())
	if err != nil {
		t.Fatal(err)
	}

	req, err = http.NewRequest("GET", "/metrics", nil)
	if err != nil {
		t.Fatal(err)
	}

	rr = httptest.NewRecorder()
	prometheus.Handler().ServeHTTP(rr, req)
	if err != nil {
		t.Fatal(err)
	}

	io.Copy(os.Stdout, rr.Body)
}

var testData = `
{
  "upstreamZones": {
    "zone1": [
      {
        "overCounts": {
          "5xx": 0,
          "maxIntegerSize": 18446744073709552000,
          "requestCounter": 0,
          "inBytes": 0,
          "outBytes": 0,
          "1xx": 0,
          "2xx": 0,
          "3xx": 0,
          "4xx": 0
        },
        "down": false,
        "backup": false,
        "failTimeout": 0,
        "maxFails": 0,
        "weight": 1,
        "responseMsecs": {
          "msecs": [
            73,
            176,
            7,
            136,
            82,
            31,
            27,
            1,
            299,
            16,
            85,
            82,
            36,
            78,
            425,
            28,
            349,
            49,
            227,
            17,
            59,
            88,
            0,
            540,
            96,
            37,
            69,
            74,
            29,
            1,
            219,
            300,
            112,
            133,
            436,
            77,
            123,
            27,
            29,
            197,
            183,
            25,
            78,
            37,
            96,
            185,
            199,
            134,
            191,
            38,
            583,
            1,
            65,
            42,
            44,
            46,
            32,
            60,
            39,
            72,
            92,
            174,
            135
          ],
          "times": [
            1519414409052,
            1519414409964,
            1519414410825,
            1519414410916,
            1519414411664,
            1519414412287,
            1519414412773,
            1519414412830,
            1519414413112,
            1519414413377,
            1519414413442,
            1519414414361,
            1519414414688,
            1519414414877,
            1519414415028,
            1519414415701,
            1519414416138,
            1519414416803,
            1519414417398,
            1519414417575,
            1519414418245,
            1519414418388,
            1519414418398,
            1519414418846,
            1519414420799,
            1519414420824,
            1519414420834,
            1519414421718,
            1519414422408,
            1519414422503,
            1519414422770,
            1519414422881,
            1519414422920,
            1519414423351,
            1519414424556,
            1519414425720,
            1519414426027,
            1519414426486,
            1519414426631,
            1519414427613,
            1519414427613,
            1519414427713,
            1519414427932,
            1519414429130,
            1519414429151,
            1519414430723,
            1519414431005,
            1519414431091,
            1519414431110,
            1519414431403,
            1519414431409,
            1519414432472,
            1519414432915,
            1519414433264,
            1519414433859,
            1519414434090,
            1519414434248,
            1519414434495,
            1519414434521,
            1519414435047,
            1519414435391,
            1519414435625,
            1519414435681
          ]
        },
        "server": "10.221.17.12:5000",
        "requestCounter": 15228,
        "inBytes": 55842568,
        "outBytes": 137382024,
        "responses": {
          "5xx": 0,
          "4xx": 893,
          "3xx": 2593,
          "2xx": 11742,
          "1xx": 0
        },
        "requestMsec": 119,
        "requestMsecs": {
          "msecs": [
            74,
            176,
            7,
            136,
            82,
            31,
            27,
            1,
            300,
            16,
            85,
            83,
            36,
            78,
            426,
            28,
            349,
            49,
            228,
            17,
            59,
            88,
            74,
            540,
            96,
            37,
            69,
            74,
            29,
            1,
            219,
            300,
            112,
            133,
            436,
            77,
            123,
            27,
            29,
            197,
            183,
            25,
            78,
            37,
            96,
            185,
            199,
            134,
            191,
            38,
            583,
            1,
            65,
            42,
            44,
            46,
            32,
            60,
            39,
            72,
            93,
            174,
            135
          ],
          "times": [
            1519414409052,
            1519414409964,
            1519414410825,
            1519414410916,
            1519414411664,
            1519414412287,
            1519414412773,
            1519414412830,
            1519414413112,
            1519414413377,
            1519414413442,
            1519414414361,
            1519414414688,
            1519414414877,
            1519414415028,
            1519414415701,
            1519414416138,
            1519414416803,
            1519414417398,
            1519414417575,
            1519414418245,
            1519414418388,
            1519414418398,
            1519414418846,
            1519414420799,
            1519414420824,
            1519414420834,
            1519414421718,
            1519414422408,
            1519414422503,
            1519414422770,
            1519414422881,
            1519414422920,
            1519414423351,
            1519414424556,
            1519414425720,
            1519414426027,
            1519414426486,
            1519414426631,
            1519414427613,
            1519414427613,
            1519414427713,
            1519414427932,
            1519414429130,
            1519414429151,
            1519414430723,
            1519414431005,
            1519414431091,
            1519414431110,
            1519414431403,
            1519414431409,
            1519414432472,
            1519414432915,
            1519414433264,
            1519414433859,
            1519414434090,
            1519414434248,
            1519414434495,
            1519414434521,
            1519414435047,
            1519414435391,
            1519414435625,
            1519414435681
          ]
        },
        "responseMsec": 117
      },
      {
        "overCounts": {
          "5xx": 0,
          "maxIntegerSize": 18446744073709552000,
          "requestCounter": 0,
          "inBytes": 0,
          "outBytes": 0,
          "1xx": 0,
          "2xx": 0,
          "3xx": 0,
          "4xx": 0
        },
        "down": false,
        "backup": false,
        "failTimeout": 0,
        "maxFails": 0,
        "weight": 1,
        "responseMsecs": {
          "msecs": [
            173,
            262,
            74,
            58,
            22,
            38,
            52,
            93,
            97,
            148,
            62,
            35,
            102,
            315,
            222,
            852,
            248,
            897,
            155,
            281,
            30,
            144,
            0,
            68,
            119,
            24,
            94,
            109,
            164,
            298,
            64,
            107,
            179,
            3353,
            418,
            131,
            1,
            190,
            11,
            67,
            379,
            8,
            408,
            819,
            137,
            82,
            98,
            118,
            84,
            9,
            55,
            230,
            960,
            52,
            52,
            51,
            1,
            34,
            325,
            139,
            128,
            27,
            83
          ],
          "times": [
            1519414408382,
            1519414408447,
            1519414409071,
            1519414410403,
            1519414410991,
            1519414411054,
            1519414411181,
            1519414411255,
            1519414411420,
            1519414412621,
            1519414412735,
            1519414413468,
            1519414413850,
            1519414414321,
            1519414414393,
            1519414414682,
            1519414414859,
            1519414416576,
            1519414416675,
            1519414416917,
            1519414417134,
            1519414417462,
            1519414417653,
            1519414417723,
            1519414419378,
            1519414420304,
            1519414420725,
            1519414421002,
            1519414421097,
            1519414421715,
            1519414421893,
            1519414422753,
            1519414423878,
            1519414424126,
            1519414424249,
            1519414424433,
            1519414425364,
            1519414425862,
            1519414426585,
            1519414427160,
            1519414427680,
            1519414427895,
            1519414428524,
            1519414428648,
            1519414428696,
            1519414429590,
            1519414430124,
            1519414430273,
            1519414430821,
            1519414431095,
            1519414431096,
            1519414432296,
            1519414433031,
            1519414433063,
            1519414433193,
            1519414433337,
            1519414433569,
            1519414433864,
            1519414434021,
            1519414434617,
            1519414435339,
            1519414435376,
            1519414435788
          ]
        },
        "server": "10.221.0.197:5000",
        "requestCounter": 14415,
        "inBytes": 28482566,
        "outBytes": 129122445,
        "responses": {
          "5xx": 0,
          "4xx": 931,
          "3xx": 2429,
          "2xx": 11055,
          "1xx": 0
        },
        "requestMsec": 233,
        "requestMsecs": {
          "msecs": [
            173,
            262,
            74,
            58,
            22,
            38,
            52,
            93,
            98,
            148,
            62,
            35,
            102,
            315,
            222,
            852,
            248,
            897,
            155,
            281,
            30,
            144,
            655,
            68,
            119,
            24,
            94,
            109,
            164,
            298,
            64,
            107,
            179,
            3353,
            418,
            131,
            1,
            190,
            11,
            67,
            379,
            8,
            408,
            819,
            137,
            82,
            98,
            118,
            84,
            9,
            55,
            230,
            960,
            52,
            52,
            51,
            1,
            34,
            325,
            139,
            129,
            27,
            83
          ],
          "times": [
            1519414408382,
            1519414408447,
            1519414409071,
            1519414410403,
            1519414410991,
            1519414411054,
            1519414411181,
            1519414411255,
            1519414411420,
            1519414412621,
            1519414412735,
            1519414413468,
            1519414413850,
            1519414414321,
            1519414414393,
            1519414414682,
            1519414414859,
            1519414416576,
            1519414416675,
            1519414416917,
            1519414417134,
            1519414417462,
            1519414417653,
            1519414417723,
            1519414419378,
            1519414420304,
            1519414420725,
            1519414421002,
            1519414421097,
            1519414421715,
            1519414421893,
            1519414422753,
            1519414423878,
            1519414424126,
            1519414424249,
            1519414424433,
            1519414425364,
            1519414425862,
            1519414426585,
            1519414427160,
            1519414427680,
            1519414427895,
            1519414428524,
            1519414428648,
            1519414428696,
            1519414429590,
            1519414430124,
            1519414430273,
            1519414430821,
            1519414431095,
            1519414431096,
            1519414432296,
            1519414433031,
            1519414433063,
            1519414433193,
            1519414433337,
            1519414433569,
            1519414433864,
            1519414434021,
            1519414434617,
            1519414435339,
            1519414435376,
            1519414435788
          ]
        },
        "responseMsec": 222
      },
      {
        "overCounts": {
          "5xx": 0,
          "maxIntegerSize": 18446744073709552000,
          "requestCounter": 0,
          "inBytes": 0,
          "outBytes": 0,
          "1xx": 0,
          "2xx": 0,
          "3xx": 0,
          "4xx": 0
        },
        "down": false,
        "backup": false,
        "failTimeout": 0,
        "maxFails": 0,
        "weight": 1,
        "responseMsecs": {
          "msecs": [
            58,
            73,
            297,
            21,
            382,
            64,
            197,
            42,
            55,
            154,
            77,
            139,
            801,
            37,
            195,
            173,
            244,
            82,
            201,
            249,
            398,
            172,
            1,
            58,
            779,
            499,
            240,
            429,
            31,
            281,
            3,
            7,
            200,
            42,
            1380,
            64,
            66,
            706,
            169,
            61,
            129,
            42,
            77,
            279,
            194,
            287,
            128,
            42,
            294,
            65,
            229,
            90,
            373,
            271,
            109,
            77,
            151,
            44,
            111,
            512,
            193,
            536,
            531
          ],
          "times": [
            1519414408539,
            1519414408740,
            1519414409209,
            1519414409456,
            1519414410058,
            1519414410858,
            1519414411053,
            1519414411060,
            1519414412488,
            1519414412573,
            1519414413307,
            1519414413432,
            1519414413672,
            1519414413854,
            1519414414301,
            1519414415399,
            1519414415443,
            1519414416151,
            1519414416463,
            1519414416524,
            1519414416686,
            1519414416740,
            1519414417898,
            1519414418408,
            1519414419441,
            1519414419986,
            1519414420742,
            1519414421177,
            1519414421212,
            1519414421387,
            1519414421736,
            1519414422393,
            1519414422556,
            1519414424333,
            1519414424447,
            1519414424720,
            1519414425606,
            1519414426217,
            1519414426273,
            1519414426779,
            1519414426789,
            1519414427997,
            1519414428061,
            1519414428685,
            1519414429009,
            1519414429084,
            1519414429999,
            1519414430023,
            1519414431079,
            1519414431271,
            1519414431593,
            1519414431618,
            1519414432231,
            1519414432355,
            1519414432691,
            1519414433300,
            1519414433380,
            1519414433722,
            1519414434409,
            1519414435042,
            1519414435206,
            1519414436012,
            1519414436064
          ]
        },
        "server": "10.221.0.196:5000",
        "requestCounter": 14341,
        "inBytes": 38518397,
        "outBytes": 131461448,
        "responses": {
          "5xx": 0,
          "4xx": 937,
          "3xx": 2460,
          "2xx": 10944,
          "1xx": 0
        },
        "requestMsec": 220,
        "requestMsecs": {
          "msecs": [
            58,
            73,
            297,
            21,
            382,
            64,
            197,
            42,
            55,
            154,
            77,
            139,
            801,
            37,
            195,
            173,
            244,
            82,
            201,
            249,
            398,
            172,
            1,
            58,
            779,
            499,
            240,
            429,
            31,
            281,
            3,
            7,
            200,
            42,
            1380,
            64,
            66,
            706,
            169,
            61,
            129,
            42,
            77,
            279,
            194,
            287,
            128,
            42,
            294,
            65,
            229,
            90,
            373,
            271,
            109,
            77,
            151,
            44,
            111,
            512,
            193,
            536,
            531
          ],
          "times": [
            1519414408539,
            1519414408740,
            1519414409209,
            1519414409456,
            1519414410058,
            1519414410858,
            1519414411053,
            1519414411060,
            1519414412488,
            1519414412573,
            1519414413307,
            1519414413432,
            1519414413672,
            1519414413854,
            1519414414301,
            1519414415399,
            1519414415443,
            1519414416151,
            1519414416463,
            1519414416524,
            1519414416686,
            1519414416740,
            1519414417898,
            1519414418408,
            1519414419441,
            1519414419986,
            1519414420742,
            1519414421177,
            1519414421212,
            1519414421387,
            1519414421736,
            1519414422393,
            1519414422556,
            1519414424333,
            1519414424447,
            1519414424720,
            1519414425606,
            1519414426217,
            1519414426273,
            1519414426779,
            1519414426789,
            1519414427997,
            1519414428061,
            1519414428685,
            1519414429009,
            1519414429084,
            1519414429999,
            1519414430023,
            1519414431079,
            1519414431271,
            1519414431593,
            1519414431618,
            1519414432231,
            1519414432355,
            1519414432691,
            1519414433300,
            1519414433380,
            1519414433722,
            1519414434409,
            1519414435042,
            1519414435206,
            1519414436012,
            1519414436064
          ]
        },
        "responseMsec": 220
      },
      {
        "overCounts": {
          "5xx": 0,
          "maxIntegerSize": 18446744073709552000,
          "requestCounter": 0,
          "inBytes": 0,
          "outBytes": 0,
          "1xx": 0,
          "2xx": 0,
          "3xx": 0,
          "4xx": 0
        },
        "down": false,
        "backup": false,
        "failTimeout": 0,
        "maxFails": 0,
        "weight": 1,
        "responseMsecs": {
          "msecs": [
            67,
            1,
            111,
            144,
            24,
            98,
            67,
            122,
            17,
            98,
            434,
            163,
            1656,
            49,
            120,
            69,
            30,
            79,
            78,
            79,
            672,
            376,
            77,
            48,
            398,
            112,
            76,
            139,
            31,
            17,
            0,
            312,
            149,
            70,
            105,
            50,
            109,
            35,
            170,
            82,
            107,
            141,
            498,
            59,
            117,
            6,
            155,
            23,
            161,
            412,
            179,
            142,
            41,
            28,
            78,
            35,
            38,
            31,
            18,
            255,
            248,
            251,
            220
          ],
          "times": [
            1519414409714,
            1519414410207,
            1519414411054,
            1519414411139,
            1519414411198,
            1519414411310,
            1519414411404,
            1519414412095,
            1519414413203,
            1519414413723,
            1519414413732,
            1519414413849,
            1519414414782,
            1519414415314,
            1519414416259,
            1519414416410,
            1519414416457,
            1519414417127,
            1519414417321,
            1519414417746,
            1519414417977,
            1519414418277,
            1519414419702,
            1519414420150,
            1519414420535,
            1519414420767,
            1519414420789,
            1519414422482,
            1519414422495,
            1519414422713,
            1519414422811,
            1519414422975,
            1519414423600,
            1519414423901,
            1519414425260,
            1519414425961,
            1519414426794,
            1519414426996,
            1519414427014,
            1519414427463,
            1519414427526,
            1519414428464,
            1519414428839,
            1519414429371,
            1519414429673,
            1519414429895,
            1519414430008,
            1519414430181,
            1519414431346,
            1519414431655,
            1519414431845,
            1519414431908,
            1519414432249,
            1519414432827,
            1519414432865,
            1519414432899,
            1519414433894,
            1519414434724,
            1519414434794,
            1519414435026,
            1519414435449,
            1519414435452,
            1519414435661
          ]
        },
        "server": "10.221.2.178:5000",
        "requestCounter": 15255,
        "inBytes": 40741808,
        "outBytes": 141220847,
        "responses": {
          "5xx": 0,
          "4xx": 866,
          "3xx": 2561,
          "2xx": 11828,
          "1xx": 0
        },
        "requestMsec": 155,
        "requestMsecs": {
          "msecs": [
            67,
            1,
            111,
            144,
            24,
            98,
            67,
            122,
            17,
            98,
            434,
            163,
            1656,
            49,
            120,
            69,
            32,
            79,
            78,
            79,
            672,
            376,
            77,
            48,
            398,
            112,
            76,
            139,
            31,
            17,
            46,
            312,
            149,
            70,
            105,
            50,
            109,
            35,
            170,
            82,
            107,
            141,
            498,
            59,
            117,
            6,
            155,
            23,
            161,
            412,
            179,
            142,
            41,
            28,
            78,
            35,
            38,
            31,
            18,
            255,
            248,
            251,
            220
          ],
          "times": [
            1519414409714,
            1519414410207,
            1519414411054,
            1519414411139,
            1519414411198,
            1519414411310,
            1519414411404,
            1519414412095,
            1519414413203,
            1519414413723,
            1519414413732,
            1519414413849,
            1519414414782,
            1519414415314,
            1519414416259,
            1519414416410,
            1519414416457,
            1519414417127,
            1519414417321,
            1519414417746,
            1519414417977,
            1519414418277,
            1519414419702,
            1519414420150,
            1519414420535,
            1519414420767,
            1519414420789,
            1519414422482,
            1519414422495,
            1519414422713,
            1519414422811,
            1519414422975,
            1519414423600,
            1519414423901,
            1519414425260,
            1519414425961,
            1519414426794,
            1519414426996,
            1519414427014,
            1519414427463,
            1519414427526,
            1519414428464,
            1519414428839,
            1519414429371,
            1519414429673,
            1519414429895,
            1519414430008,
            1519414430181,
            1519414431346,
            1519414431655,
            1519414431845,
            1519414431908,
            1519414432249,
            1519414432827,
            1519414432865,
            1519414432899,
            1519414433894,
            1519414434724,
            1519414434794,
            1519414435026,
            1519414435449,
            1519414435452,
            1519414435661
          ]
        },
        "responseMsec": 155
      },
      {
        "overCounts": {
          "5xx": 0,
          "maxIntegerSize": 18446744073709552000,
          "requestCounter": 0,
          "inBytes": 0,
          "outBytes": 0,
          "1xx": 0,
          "2xx": 0,
          "3xx": 0,
          "4xx": 0
        },
        "down": false,
        "backup": false,
        "failTimeout": 0,
        "maxFails": 0,
        "weight": 1,
        "responseMsecs": {
          "msecs": [
            99,
            137,
            142,
            133,
            159,
            351,
            102,
            72,
            161,
            153,
            18,
            36,
            120,
            232,
            97,
            366,
            107,
            120,
            79,
            46,
            47,
            19,
            0,
            68,
            72,
            75,
            88,
            129,
            51,
            36,
            709,
            100,
            190,
            1,
            134,
            70,
            69,
            11,
            61,
            145,
            2876,
            73,
            43,
            40,
            36,
            200,
            92,
            92,
            59,
            280,
            31,
            79,
            28,
            98,
            219,
            40,
            33,
            145,
            35,
            170,
            75,
            46,
            9
          ],
          "times": [
            1519414409444,
            1519414409942,
            1519414410197,
            1519414411055,
            1519414411201,
            1519414411892,
            1519414412078,
            1519414412872,
            1519414412940,
            1519414413233,
            1519414413490,
            1519414413669,
            1519414414720,
            1519414415501,
            1519414415763,
            1519414416155,
            1519414416700,
            1519414417072,
            1519414417087,
            1519414417666,
            1519414417817,
            1519414418402,
            1519414418430,
            1519414418615,
            1519414419307,
            1519414420989,
            1519414421585,
            1519414421924,
            1519414421975,
            1519414422209,
            1519414422865,
            1519414423229,
            1519414424443,
            1519414425200,
            1519414426124,
            1519414426234,
            1519414426646,
            1519414427186,
            1519414427243,
            1519414428247,
            1519414428617,
            1519414428704,
            1519414429074,
            1519414429373,
            1519414429486,
            1519414429750,
            1519414430279,
            1519414431290,
            1519414431466,
            1519414431526,
            1519414431925,
            1519414432483,
            1519414432574,
            1519414433108,
            1519414433556,
            1519414433673,
            1519414434234,
            1519414435006,
            1519414435064,
            1519414435372,
            1519414435399,
            1519414435494,
            1519414435850
          ]
        },
        "server": "10.221.11.103:5000",
        "requestCounter": 15265,
        "inBytes": 43712028,
        "outBytes": 143289265,
        "responses": {
          "5xx": 0,
          "4xx": 864,
          "3xx": 2593,
          "2xx": 11808,
          "1xx": 0
        },
        "requestMsec": 153,
        "requestMsecs": {
          "msecs": [
            99,
            137,
            142,
            133,
            159,
            351,
            102,
            72,
            161,
            153,
            18,
            36,
            120,
            232,
            97,
            366,
            107,
            120,
            79,
            46,
            47,
            19,
            76,
            68,
            72,
            75,
            88,
            129,
            51,
            36,
            709,
            100,
            190,
            1,
            134,
            70,
            69,
            11,
            61,
            145,
            2876,
            73,
            43,
            40,
            36,
            200,
            92,
            92,
            59,
            280,
            39,
            79,
            29,
            98,
            219,
            40,
            33,
            145,
            35,
            170,
            75,
            46,
            9
          ],
          "times": [
            1519414409444,
            1519414409942,
            1519414410197,
            1519414411055,
            1519414411201,
            1519414411892,
            1519414412078,
            1519414412872,
            1519414412940,
            1519414413233,
            1519414413490,
            1519414413669,
            1519414414720,
            1519414415501,
            1519414415763,
            1519414416155,
            1519414416700,
            1519414417072,
            1519414417087,
            1519414417666,
            1519414417817,
            1519414418402,
            1519414418430,
            1519414418615,
            1519414419307,
            1519414420989,
            1519414421585,
            1519414421924,
            1519414421975,
            1519414422209,
            1519414422865,
            1519414423229,
            1519414424443,
            1519414425200,
            1519414426124,
            1519414426234,
            1519414426646,
            1519414427186,
            1519414427243,
            1519414428247,
            1519414428617,
            1519414428704,
            1519414429074,
            1519414429373,
            1519414429486,
            1519414429750,
            1519414430279,
            1519414431290,
            1519414431466,
            1519414431526,
            1519414431925,
            1519414432483,
            1519414432574,
            1519414433108,
            1519414433556,
            1519414433673,
            1519414434234,
            1519414435006,
            1519414435064,
            1519414435372,
            1519414435399,
            1519414435494,
            1519414435850
          ]
        }
      }
	  ]
	}
  }
}
`
